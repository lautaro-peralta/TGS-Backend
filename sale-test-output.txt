
> proyecto_tgs@1.0.0 test:unit C:\Users\Usuario\Documents\GitHub\TGS-Backend
> cross-env NODE_ENV=test jest tests/unit "tests/unit/sale/sale.controller.test.ts"

  console.log
    [dotenv@17.2.0] injecting env (22) from .env.test (tip: ‚öôÔ∏è  suppress all logs with { quiet: true })

      at _log (node_modules/.pnpm/dotenv@17.2.0/node_modules/dotenv/lib/main.js:136:11)

FAIL tests/unit/sale/sale.controller.test.ts
  ‚óè Test suite failed to run

    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m86[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType '{ params: {}; query: {}; body: {}; user: undefined; }' is not assignable to type 'Partial<Request<ParamsDictionary, any, any, ParsedQs, Record<string, any>>>'.
      Object literal may only specify known properties, and 'user' does not exist in type 'Partial<Request<ParamsDictionary, any, any, ParsedQs, Record<string, any>>>'.

    [7m86[0m       user: undefined
    [7m  [0m [91m      ~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m133[0m:[93m73[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Partial<Response<any, Record<string, any>>>' is not assignable to parameter of type 'never'.

    [7m133[0m       (searchEntityWithPaginationCached as jest.Mock).mockResolvedValue(mockResponse);
    [7m   [0m [91m                                                                        ~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m139[0m:[93m9[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Partial<Request<ParamsDictionary, any, any, ParsedQs, Record<string, any>>>' is not assignable to parameter of type 'AsymmetricMatcher_2 | { secret?: string | AsymmetricMatcher_2 | undefined; cookies: AsymmetricMatcher_2 | { ...; }; ... 108 more ...; files?: AsymmetricMatcher_2 | ... 2 more ... | undefined; }'.
      Type 'Partial<Request<ParamsDictionary, any, any, ParsedQs, Record<string, any>>>' is not assignable to type '{ secret?: string | AsymmetricMatcher_2 | undefined; cookies: AsymmetricMatcher_2 | { [x: string]: any; }; signedCookies: AsymmetricMatcher_2 | { ...; }; ... 107 more ...; files?: AsymmetricMatcher_2 | ... 2 more ... | undefined; }'.
        Types of property 'cookies' are incompatible.
          Type 'Record<string, any> | undefined' is not assignable to type 'AsymmetricMatcher_2 | { [x: string]: any; }'.
            Type 'undefined' is not assignable to type 'AsymmetricMatcher_2 | { [x: string]: any; }'.

    [7m139[0m         mockRequest,
    [7m   [0m [91m        ~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m154[0m:[93m43[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 6.

    [7m154[0m       const mockAuthority = new Authority('12345678', 'Partner Auth', 'partner@test.com', '123456', 'Address', 1);
    [7m   [0m [91m                                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m155[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'number' is not assignable to type 'string'.

    [7m155[0m       mockAuthority.id = 1;
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m166[0m:[93m25[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m166[0m         const filters = options.buildFilters();
    [7m   [0m [91m                        ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m181[0m:[93m47[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m181[0m       const mockDistributor = new Distributor('87654321', 'Distributor Name', 'dist@test.com', '654321', 'Address');
    [7m   [0m [91m                                              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m193[0m:[93m25[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m193[0m         const filters = options.buildFilters();
    [7m   [0m [91m                        ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m211[0m:[93m16[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m211[0m         expect(options.searchFields).toBe('distributor.name');
    [7m   [0m [91m               ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m226[0m:[93m16[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m226[0m         expect(options.searchFields).toBe('distributor.zone.name');
    [7m   [0m [91m               ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m241[0m:[93m25[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m241[0m         const filters = options.buildFilters();
    [7m   [0m [91m                        ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m259[0m:[93m25[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m259[0m         const filters = options.buildFilters();
    [7m   [0m [91m                        ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m275[0m:[93m25[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m275[0m         const filters = options.buildFilters();
    [7m   [0m [91m                        ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m295[0m:[93m25[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m295[0m         const filters = options.buildFilters();
    [7m   [0m [91m                        ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m324[0m:[93m46[0m - [91merror[0m[90m TS2345: [0mArgument of type '{ date: string; total: string; }[]' is not assignable to parameter of type 'never'.

    [7m324[0m         orderBy: jest.fn().mockResolvedValue([
    [7m   [0m [91m                                             ~[0m
    [7m325[0m           { date: '2025-01-01', total: '1500.50' },
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m326[0m           { date: '2025-01-02', total: '2300.75' }
    [7m   [0m [91m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [7m327[0m         ]),
    [7m   [0m [91m~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m416[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.
      Type 'unknown' is not assignable to type 'boolean'.

    [7m416[0m       mockUser.canPurchase = jest.fn().mockReturnValue(false);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m417[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => string[]'.
      Type 'unknown' is not assignable to type 'string[]'.

    [7m417[0m       mockUser.getPurchaseRequirementSuggestions = jest.fn().mockReturnValue(['Complete profile']);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m436[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.

    [7m436[0m       mockUser.canPurchase = jest.fn().mockReturnValue(true);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m460[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.

    [7m460[0m       mockUser.canPurchase = jest.fn().mockReturnValue(true);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m463[0m:[93m37[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m463[0m       const mockClient = new Client('12345678', 'Test Client', 'client@test.com', '123456', 'Address');
    [7m   [0m [91m                                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m464[0m:[93m47[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m464[0m       const mockDistributor = new Distributor('87654321', 'Test Distributor', 'dist@test.com', '654321', 'Address');
    [7m   [0m [91m                                              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m465[0m:[93m39[0m - [91merror[0m[90m TS2345: [0mArgument of type 'string' is not assignable to parameter of type 'number'.

    [7m465[0m       const mockProduct = new Product('Product 1', 'Description', 100, false);
    [7m   [0m [91m                                      ~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m468[0m:[93m33[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m468[0m       const mockSale = new Sale(mockClient, mockDistributor, new Date(), 200, []);
    [7m   [0m [91m                                ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m482[0m:[93m52[0m - [91merror[0m[90m TS7006: [0mParameter 'entity' implicitly has an 'any' type.

    [7m482[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                   ~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m482[0m:[93m60[0m - [91merror[0m[90m TS7006: [0mParameter 'data' implicitly has an 'any' type.

    [7m482[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                           ~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m503[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.

    [7m503[0m       mockUser.canPurchase = jest.fn().mockReturnValue(true);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m529[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.

    [7m529[0m       mockUser.canPurchase = jest.fn().mockReturnValue(true);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m530[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'null' is not assignable to type '({ id: string; } & Reference<BasePersonEntity & object>) | undefined'.

    [7m530[0m       mockUser.person = null;
    [7m   [0m [91m      ~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m532[0m:[93m7[0m - [91merror[0m[90m TS18048: [0m'mockResponse.locals' is possibly 'undefined'.

    [7m532[0m       mockResponse.locals.validated.body = {
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m544[0m:[93m47[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m544[0m       const mockDistributor = new Distributor('87654321', 'Test Distributor', 'dist@test.com', '654321', 'Address');
    [7m   [0m [91m                                              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m545[0m:[93m39[0m - [91merror[0m[90m TS2345: [0mArgument of type 'string' is not assignable to parameter of type 'number'.

    [7m545[0m       const mockProduct = new Product('Product 1', 'Description', 100, false);
    [7m   [0m [91m                                      ~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m548[0m:[93m51[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m548[0m       const mockBasePerson = new BasePersonEntity('12345678', 'New Client', 'new@test.com', '123456', 'Address');
    [7m   [0m [91m                                                  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m549[0m:[93m37[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m549[0m       const mockClient = new Client('12345678', 'New Client', 'new@test.com', '123456', 'Address');
    [7m   [0m [91m                                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m551[0m:[93m33[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m551[0m       const mockSale = new Sale(mockClient, mockDistributor, new Date(), 200, []);
    [7m   [0m [91m                                ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m566[0m:[93m52[0m - [91merror[0m[90m TS7006: [0mParameter 'entity' implicitly has an 'any' type.

    [7m566[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                   ~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m566[0m:[93m60[0m - [91merror[0m[90m TS7006: [0mParameter 'data' implicitly has an 'any' type.

    [7m566[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                           ~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m596[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.

    [7m596[0m       mockUser.canPurchase = jest.fn().mockReturnValue(true);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m597[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'null' is not assignable to type '({ id: string; } & Reference<BasePersonEntity & object>) | undefined'.

    [7m597[0m       mockUser.person = null;
    [7m   [0m [91m      ~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m599[0m:[93m7[0m - [91merror[0m[90m TS18048: [0m'mockResponse.locals' is possibly 'undefined'.

    [7m599[0m       mockResponse.locals.validated.body = {
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m623[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.

    [7m623[0m       mockUser.canPurchase = jest.fn().mockReturnValue(true);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m626[0m:[93m37[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m626[0m       const mockClient = new Client('12345678', 'Test Client', 'client@test.com', '123456', 'Address');
    [7m   [0m [91m                                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m627[0m:[93m47[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m627[0m       const mockDistributor = new Distributor('87654321', 'Test Distributor', 'dist@test.com', '654321', 'Address');
    [7m   [0m [91m                                              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m638[0m:[93m52[0m - [91merror[0m[90m TS7006: [0mParameter 'entity' implicitly has an 'any' type.

    [7m638[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                   ~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m638[0m:[93m60[0m - [91merror[0m[90m TS7006: [0mParameter 'data' implicitly has an 'any' type.

    [7m638[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                           ~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m659[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.

    [7m659[0m       mockUser.canPurchase = jest.fn().mockReturnValue(true);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m662[0m:[93m37[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m662[0m       const mockClient = new Client('12345678', 'Test Client', 'client@test.com', '123456', 'Address');
    [7m   [0m [91m                                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m664[0m:[93m47[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m664[0m       const mockDistributor = new Distributor('87654321', 'Test Distributor', 'dist@test.com', '654321', 'Address');
    [7m   [0m [91m                                              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m667[0m:[93m46[0m - [91merror[0m[90m TS2345: [0mArgument of type 'string' is not assignable to parameter of type 'number'.

    [7m667[0m       const mockIllegalProduct = new Product('Illegal Product', 'Description', 500, true);
    [7m   [0m [91m                                             ~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m671[0m:[93m43[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 6.

    [7m671[0m       const mockAuthority = new Authority('99999999', 'Authority Name', 'auth@test.com', '999999', 'Address', 1);
    [7m   [0m [91m                                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m672[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'number' is not assignable to type 'string'.

    [7m672[0m       mockAuthority.id = 1;
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m674[0m:[93m33[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m674[0m       const mockSale = new Sale(mockClient, mockDistributor, new Date(), 1000, []);
    [7m   [0m [91m                                ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m694[0m:[93m52[0m - [91merror[0m[90m TS7006: [0mParameter 'entity' implicitly has an 'any' type.

    [7m694[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                   ~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m694[0m:[93m60[0m - [91merror[0m[90m TS7006: [0mParameter 'data' implicitly has an 'any' type.

    [7m694[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                           ~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m722[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.

    [7m722[0m       mockUser.canPurchase = jest.fn().mockReturnValue(true);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m725[0m:[93m37[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m725[0m       const mockClient = new Client('12345678', 'Test Client', 'client@test.com', '123456', 'Address');
    [7m   [0m [91m                                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m726[0m:[93m47[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m726[0m       const mockDistributor = new Distributor('87654321', 'Test Distributor', 'dist@test.com', '654321', 'Address');
    [7m   [0m [91m                                              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m727[0m:[93m39[0m - [91merror[0m[90m TS2345: [0mArgument of type 'string' is not assignable to parameter of type 'number'.

    [7m727[0m       const mockProduct = new Product('Product 1', 'Description', 100, false);
    [7m   [0m [91m                                      ~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m730[0m:[93m33[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m730[0m       const mockSale = new Sale(mockClient, mockDistributor, new Date(), 200, []);
    [7m   [0m [91m                                ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m744[0m:[93m52[0m - [91merror[0m[90m TS7006: [0mParameter 'entity' implicitly has an 'any' type.

    [7m744[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                   ~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m744[0m:[93m60[0m - [91merror[0m[90m TS7006: [0mParameter 'data' implicitly has an 'any' type.

    [7m744[0m       mockEntityManager.create.mockImplementation((entity, data) => {
    [7m   [0m [91m                                                           ~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m761[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'Mock<UnknownFunction>' is not assignable to type '() => boolean'.

    [7m761[0m       mockUser.canPurchase = jest.fn().mockReturnValue(true);
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m847[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'null' is not assignable to type '({ id: string; } & Reference<BasePersonEntity & object>) | undefined'.

    [7m847[0m       mockUser.person = null;
    [7m   [0m [91m      ~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m876[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'null' is not assignable to type '({ id: string; } & Reference<BasePersonEntity & object>) | undefined'.

    [7m876[0m       mockUser.person = null;
    [7m   [0m [91m      ~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m946[0m:[93m73[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Partial<Response<any, Record<string, any>>>' is not assignable to parameter of type 'never'.

    [7m946[0m       (searchEntityWithPaginationCached as jest.Mock).mockResolvedValue(mockResponse);
    [7m   [0m [91m                                                                        ~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m951[0m:[93m9[0m - [91merror[0m[90m TS2345: [0mArgument of type 'Partial<Request<ParamsDictionary, any, any, ParsedQs, Record<string, any>>>' is not assignable to parameter of type 'AsymmetricMatcher_2 | { secret?: string | AsymmetricMatcher_2 | undefined; cookies: AsymmetricMatcher_2 | { ...; }; ... 108 more ...; files?: AsymmetricMatcher_2 | ... 2 more ... | undefined; }'.

    [7m951[0m         mockRequest,
    [7m   [0m [91m        ~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m966[0m:[93m43[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 6.

    [7m966[0m       const mockAuthority = new Authority('12345678', 'Partner Auth', 'partner@test.com', '123456', 'Address', 1);
    [7m   [0m [91m                                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m967[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'number' is not assignable to type 'string'.

    [7m967[0m       mockAuthority.id = 1;
    [7m   [0m [91m      ~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m976[0m:[93m25[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m976[0m         const filters = options.buildFilters();
    [7m   [0m [91m                        ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m991[0m:[93m47[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m991[0m       const mockDistributor = new Distributor('87654321', 'Distributor Name', 'dist@test.com', '654321', 'Address');
    [7m   [0m [91m                                              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m1000[0m:[93m25[0m - [91merror[0m[90m TS18046: [0m'options' is of type 'unknown'.

    [7m1000[0m         const filters = options.buildFilters();
    [7m    [0m [91m                        ~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m1073[0m:[93m44[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 6.

    [7m1073[0m       const mockAuthority1 = new Authority('11111111', 'Auth 1', 'auth1@test.com', '111111', 'Address', 1);
    [7m    [0m [91m                                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m1074[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'number' is not assignable to type 'string'.

    [7m1074[0m       mockAuthority1.id = 1;
    [7m    [0m [91m      ~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m1076[0m:[93m44[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 6.

    [7m1076[0m       const mockAuthority2 = new Authority('22222222', 'Auth 2', 'auth2@test.com', '222222', 'Address', 1);
    [7m    [0m [91m                                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m1077[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'number' is not assignable to type 'string'.

    [7m1077[0m       mockAuthority2.id = 2;
    [7m    [0m [91m      ~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m1108[0m:[93m43[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 6.

    [7m1108[0m       const mockAuthority = new Authority('11111111', 'Auth 1', 'auth1@test.com', '111111', 'Address', 1);
    [7m    [0m [91m                                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m1109[0m:[93m7[0m - [91merror[0m[90m TS2322: [0mType 'number' is not assignable to type 'string'.

    [7m1109[0m       mockAuthority.id = 1;
    [7m    [0m [91m      ~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m1214[0m:[93m50[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 5.

    [7m1214[0m       const mockNewDistributor = new Distributor('22222222', 'New Distributor', 'new@test.com', '222222', 'Address');
    [7m    [0m [91m                                                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m
    [96mtests/unit/sale/sale.controller.test.ts[0m:[93m1264[0m:[93m46[0m - [91merror[0m[90m TS2554: [0mExpected 0 arguments, but got 6.

    [7m1264[0m       const mockNewAuthority = new Authority('22222222', 'New Authority', 'new@test.com', '222222', 'Address', 1);
    [7m    [0m [91m                                             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~[0m

  console.log
    [dotenv@17.2.0] injecting env (22) from .env.test (tip: ‚öôÔ∏è  suppress all logs with { quiet: true })

      at _log (node_modules/.pnpm/dotenv@17.2.0/node_modules/dotenv/lib/main.js:136:11)

PASS tests/unit/auth/user.controller.test.ts (5.411 s)
  UserController
    getUserProfile
      ‚àö should return user profile successfully (71 ms)
      ‚àö should return 404 if user not found (23 ms)
      ‚àö should handle database errors gracefully (21 ms)
    getAllUsers
      ‚àö should return all users successfully (26 ms)
      ‚àö should handle database errors (19 ms)
    getVerifiedUsers
      ‚àö should return verified users with complete profiles (23 ms)
      ‚àö should filter by targetRole=AUTHORITY (34 ms)
      ‚àö should filter by targetRole=PARTNER (36 ms)
      ‚àö should exclude users without personal info (43 ms)
      ‚àö should exclude ADMIN users by default (29 ms)
    getOneUserById
      ‚àö should find user by username (32 ms)
      ‚àö should return 404 if user not found (16 ms)
    updateUserRoles
      ‚àö should add PARTNER role successfully (41 ms)
      ‚àö should return error for invalid role (42 ms)
      ‚àö should return 404 if user not found (32 ms)
      ‚àö should clear all roles when assigning ADMIN (40 ms)
      ‚àö should reject AUTHORITY role with PARTNER (43 ms)
      ‚àö should reject ADMIN without personal info (35 ms)
      ‚àö should not duplicate existing role (54 ms)
    createUser
      ‚àö should create user successfully (51 ms)
      ‚àö should return 404 if person not found (35 ms)
      ‚àö should return 409 if person already has user (38 ms)
      ‚àö should return 409 if username exists (28 ms)
      ‚àö should return 409 if email exists (26 ms)
    updateUser
      ‚àö should update user properties successfully (52 ms)
      ‚àö should return 404 if user not found (41 ms)
      ‚àö should update roles with validation (36 ms)
      ‚àö should reject incompatible roles (28 ms)
      ‚àö should process ADMIN role assignment (63 ms)
    completeProfile
      ‚àö should complete profile successfully (49 ms)
      ‚àö should return 404 if user not found (62 ms)
      ‚àö should return error if profile already complete (37 ms)
      ‚àö should return 409 if DNI already registered (28 ms)
    updatePersonalInfo
      ‚àö should update personal info successfully (471 ms)
      ‚àö should return error if no fields provided (17 ms)
      ‚àö should return 404 if user not found (21 ms)
      ‚àö should return error if profile not complete (18 ms)
      ‚àö should update only phone if address not provided (20 ms)
      ‚àö should update only address if phone not provided (33 ms)

  console.log
    [dotenv@17.2.0] injecting env (22) from .env.test (tip: üîê prevent committing .env to code: https://dotenvx.com/precommit)

      at _log (node_modules/.pnpm/dotenv@17.2.0/node_modules/dotenv/lib/main.js:136:11)

PASS tests/unit/client/client.controller.test.ts (7.304 s)
  ClientController
    searchClients
      ‚àö should call searchEntityWithPaginationCached with correct params (21 ms)
      ‚àö should return early if validation fails (9 ms)
    createClient
      ‚àö should create client successfully without user (24 ms)
      ‚àö should create client with user when credentials provided (12 ms)
      ‚àö should return 400 if mandatory data missing (10 ms)
      ‚àö should return 409 if client with DNI already exists (15 ms)
      ‚àö should return 409 if username already exists (10 ms)
      ‚àö should handle database errors gracefully (26 ms)
    getAllClients
      ‚àö should call searchEntityWithPagination with correct params (13 ms)
    getOneClientByDni
      ‚àö should return client successfully (13 ms)
      ‚àö should return 404 if client not found (9 ms)
      ‚àö should handle database errors (13 ms)
      ‚àö should trim DNI parameter (11 ms)
    patchUpdateClient
      ‚àö should update client successfully (21 ms)
      ‚àö should return 404 if client not found (14 ms)
      ‚àö should handle database errors (14 ms)
    deleteClient
      ‚àö should delete client successfully (17 ms)
      ‚àö should return 404 if client not found (13 ms)
      ‚àö should handle database errors (13 ms)
      ‚àö should trim DNI parameter before deletion (38 ms)

  console.log
    [dotenv@17.2.0] injecting env (22) from .env.test (tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] })

      at _log (node_modules/.pnpm/dotenv@17.2.0/node_modules/dotenv/lib/main.js:136:11)

[2025-12-10 21:24:42.262 -0300] [32mINFO[39m: [36m  - User created in demo mode - email verification is optional[39m
    [35mservice[39m: "api"
    [35memail[39m: "test@example.com"
    [35mmode[39m: "demo"
[2025-12-10 21:24:42.369 -0300] [33mWARN[39m: [36m  - Reclaiming email from unverified account[39m
    [35mservice[39m: "api"
    [35memail[39m: "test@example.com"
    [35moldUserId[39m: "old-user-id"
    [35maccountAge[39m: "1 hours"
    [35moldUsername[39m: "olduser"
[2025-12-10 21:24:42.370 -0300] [32mINFO[39m: [36m  - Successfully reclaimed email from unverified account[39m
    [35mservice[39m: "api"
    [35memail[39m: "test@example.com"
    [35moldUserId[39m: "old-user-id"
[2025-12-10 21:24:42.370 -0300] [32mINFO[39m: [36m  - User created in demo mode - email verification is optional[39m
    [35mservice[39m: "api"
    [35memail[39m: "test@example.com"
    [35mmode[39m: "demo"
[2025-12-10 21:24:42.396 -0300] [32mINFO[39m: [36m  - User created in demo mode - email verification is optional[39m
    [35mservice[39m: "api"
    [35memail[39m: "test@example.com"
    [35mmode[39m: "demo"
[2025-12-10 21:24:42.439 -0300] [32mINFO[39m: [36m  - User created in demo mode - email verification is optional[39m
    [35mservice[39m: "api"
    [35memail[39m: "test@example.com"
    [35mmode[39m: "demo"
[2025-12-10 21:24:42.898 -0300] [31mERROR[39m: [36m  - Error refreshing token[39m
    [35mservice[39m: "api"
    err: {
      "type": "Error",
      "message": "Database error",
      "stack":
          Error: Database error
              at Object.<anonymous> (C:\Users\Usuario\Documents\GitHub\TGS-Backend\tests\unit\auth\auth.controller.test.ts:561:21)
              at Promise.finally.completed (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
              at new Promise (<anonymous>)
              at callAsyncCircusFn (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
              at _callCircusTest (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
              at async _runTest (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
              at async C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:849:7
              at async _runTestsForDescribeBlock (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
              at async _runTestsForDescribeBlock (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
              at async _runTestsForDescribeBlock (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
              at async run (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
              at async runAndTransformResultsToJestFormat (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
              at async jestAdapter (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-circus@30.2.0\node_modules\jest-circus\build\runner.js:101:19)
              at async runTestInternal (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-runner@30.2.0\node_modules\jest-runner\build\index.js:275:16)
              at async runTest (C:\Users\Usuario\Documents\GitHub\TGS-Backend\node_modules\.pnpm\jest-runner@30.2.0\node_modules\jest-runner\build\index.js:343:7)
    }
PASS tests/unit/auth/auth.controller.test.ts
  AuthController
    register
      ‚àö should successfully register a new user (54 ms)
      ‚àö should return 409 if username already exists (40 ms)
      ‚àö should return 409 if email already exists and is verified (20 ms)
      ‚àö should reclaim unverified email account (30 ms)
      ‚àö should hash password with argon2 (21 ms)
      ‚àö should create user with USER role by default (45 ms)
      ‚àö should call next with error when exception occurs (53 ms)
    login
      ‚àö should successfully login with valid credentials (26 ms)
      ‚àö should return 401 for invalid email (19 ms)
      ‚àö should return 401 for invalid password (30 ms)
      ‚àö should update lastLoginAt timestamp (19 ms)
      ‚àö should create refresh token in database (28 ms)
      ‚àö should call next with error when exception occurs (14 ms)
    logout
      ‚àö should successfully logout and clear cookies (30 ms)
      ‚àö should revoke refresh token if found (21 ms)
      ‚àö should handle logout without refresh token (17 ms)
      ‚àö should clear cookies even if database error occurs (18 ms)
    refresh
      ‚àö should successfully refresh tokens (23 ms)
      ‚àö should return 401 if refresh token not in cookies (43 ms)
      ‚àö should return 401 if refresh token not found in database (15 ms)
      ‚àö should return 401 if refresh token is not active (29 ms)
      ‚àö should create new refresh token (token rotation) (30 ms)
      ‚àö should handle database errors gracefully (34 ms)

  console.log
    [dotenv@17.2.0] injecting env (22) from .env.test (tip: ‚öôÔ∏è  override existing env vars with { override: true })

      at _log (node_modules/.pnpm/dotenv@17.2.0/node_modules/dotenv/lib/main.js:136:11)

PASS tests/unit/bribe/bribe.controller.test.ts
  BribeController
    searchBribes
      ‚àö should search bribes successfully without filters (28 ms)
      ‚àö should filter by paid status (paid=true) (13 ms)
      ‚àö should filter by paid status (paid=false) (10 ms)
      ‚àö should filter by authority for PARTNER users (26 ms)
      ‚àö should return early if validation fails (21 ms)
      ‚àö should handle database errors gracefully (24 ms)
      ‚àö should filter by date (exact) (16 ms)
      ‚àö should filter by date (between) (10 ms)
    createBribe
      ‚àö should create bribe successfully (39 ms)
      ‚àö should return 404 if authority not found (17 ms)
      ‚àö should return 404 if sale not found (17 ms)
      ‚àö should handle database errors (12 ms)
    getAllBribes
      ‚àö should call searchEntityWithPagination (12 ms)
      ‚àö should filter by authority for AUTHORITY role (11 ms)
    getOneBribeById
      ‚àö should return bribe successfully (11 ms)
      ‚àö should return 400 for invalid ID (11 ms)
      ‚àö should return 404 if bribe not found (13 ms)
      ‚àö should handle database errors (11 ms)
    payBribe
      ‚àö should pay bribe successfully (24 ms)
      ‚àö should return 400 for invalid ID (12 ms)
      ‚àö should return 404 if bribe not found (17 ms)
      ‚àö should handle database errors (11 ms)
    payBribes
      ‚àö should pay multiple bribes without DNI (14 ms)
      ‚àö should pay bribes by authority DNI (9 ms)
      ‚àö should return 404 if authority not found (11 ms)
      ‚àö should return 404 if no bribes found for authority (21 ms)
      ‚àö should handle database errors (12 ms)
    payBribeAmount
      ‚àö should make partial payment successfully (14 ms)
      ‚àö should return 400 for invalid ID (11 ms)
      ‚àö should return 404 if bribe not found (8 ms)
      ‚àö should return 400 if payment exceeds pending amount (11 ms)
      ‚àö should handle database errors (12 ms)
    deleteBribe
      ‚àö should delete bribe successfully (9 ms)
      ‚àö should return 400 for invalid ID (9 ms)
      ‚àö should return 404 if bribe not found (13 ms)
      ‚àö should handle database errors (13 ms)

  console.log
    [dotenv@17.2.0] injecting env (22) from .env.test (tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' })

      at _log (node_modules/.pnpm/dotenv@17.2.0/node_modules/dotenv/lib/main.js:136:11)

PASS tests/unit/auth/user.entity.test.ts
  User Entity
    Constructor
      ‚àö should create user with required parameters (15 ms)
      ‚àö should accept custom roles (12 ms)
      ‚àö should default isActive to true (8 ms)
      ‚àö should default isVerified to false (10 ms)
      ‚àö should default emailVerified to false (7 ms)
      ‚àö should default profileCompleteness to 25 (8 ms)
    canPurchase
      ‚àö should return false if user is not verified (11 ms)
      ‚àö should return false if user has no personal info (39 ms)
      ‚àö should return true if user is verified and has complete personal info (15 ms)
      ‚àö should return false if personal info is incomplete (16 ms)
    calculateProfileCompleteness
      ‚àö should return 25% for newly created user (33 ms)
      ‚àö should return 50% if user is verified but no personal info (17 ms)
      ‚àö should return 75% if user has personal info but not verified (27 ms)
      ‚àö should return 100% if user is verified and has complete personal info (21 ms)
      ‚àö should not exceed 100% (13 ms)
    hasPersonalInfo getter
      ‚àö should return false if person is undefined (20 ms)
      ‚àö should return false if personal info is incomplete (14 ms)
      ‚àö should return true if all personal info fields are present (18 ms)
    toDTO
      ‚àö should return user DTO without password (42 ms)
      ‚àö should include profile completeness in DTO (12 ms)
      ‚àö should include hasPersonalInfo in DTO (18 ms)
      ‚àö should include person data if present (15 ms)
      ‚àö should return null for person if not present (17 ms)
      ‚àö should include timestamps (35 ms)
    Role validation
      ‚àö should have valid role enum values (18 ms)
      ‚àö should allow multiple roles (17 ms)
      ‚àö should allow single role (18 ms)
    User properties
      ‚àö should have required properties (16 ms)
      ‚àö should have timestamp properties (16 ms)
    canPerformAction
      ‚àö should return false for purchase action if not verified (13 ms)
      ‚àö should return false for purchase action if no personal info (15 ms)
      ‚àö should return false for purchase action if profile completeness is not 100% (16 ms)
      ‚àö should return true for purchase action if all conditions met (13 ms)
      ‚àö should return false for admin action if profile completeness is not 100% (13 ms)
      ‚àö should return true for admin action if profile completeness is 100% (10 ms)

  console.log
    [dotenv@17.2.0] injecting env (22) from .env.test (tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject })

      at _log (node_modules/.pnpm/dotenv@17.2.0/node_modules/dotenv/lib/main.js:136:11)

PASS tests/unit/authority/authority.controller.test.ts
  AuthorityController
    searchAuthorities
      ‚àö should call searchEntityWithPagination with correct params (17 ms)
      ‚àö should filter by zone (11 ms)
      ‚àö should filter by rank (17 ms)
      ‚àö should return early if validation fails (11 ms)
    getAuthorityBribes
      ‚àö should return bribes for ADMIN user (9 ms)
      ‚àö should return bribes for AUTHORITY viewing own bribes (20 ms)
      ‚àö should return 403 for non-AUTHORITY/ADMIN user (11 ms)
      ‚àö should return 403 for AUTHORITY viewing another authority bribes (11 ms)
      ‚àö should return 404 if authority not found (32 ms)
      ‚àö should return early if validation fails (11 ms)
      ‚àö should handle database errors (22 ms)
    createAuthority
      ‚àö should create authority successfully without user (22 ms)
      ‚àö should create authority with user when credentials provided (49 ms)
      ‚àö should return 409 if DNI already exists (15 ms)
      ‚àö should return 409 if username already exists (13 ms)
      ‚àö should return 404 if zone not found (23 ms)
      ‚àö should handle database errors (13 ms)
    getAllAuthorities
      ‚àö should call searchEntityWithPagination (9 ms)
    getOneAuthorityByDni
      ‚àö should return authority successfully (17 ms)
      ‚àö should return 404 if authority not found (8 ms)
      ‚àö should handle database errors (19 ms)
    putUpdateAuthority
      ‚àö should update authority successfully (31 ms)
      ‚àö should return 404 if authority not found (10 ms)
      ‚àö should return 400 if mandatory data missing (12 ms)
      ‚àö should return 404 if zone not found (11 ms)
      ‚àö should handle database errors (23 ms)
    patchUpdateAuthority
      ‚àö should partially update authority successfully (15 ms)
      ‚àö should update zone if zoneId provided (12 ms)
      ‚àö should return 404 if authority not found (9 ms)
      ‚àö should return 404 if zone not found (13 ms)
      ‚àö should handle database errors (10 ms)
    deleteAuthority
      ‚àö should delete authority successfully (11 ms)
      ‚àö should return 404 if authority not found (9 ms)
      ‚àö should return 400 if authority has pending bribes (11 ms)
      ‚àö should remove AUTHORITY role from user before deletion (12 ms)
      ‚àö should handle database errors (10 ms)

  console.log
    [dotenv@17.2.0] injecting env (22) from .env.test (tip: üîê encrypt with dotenvx: https://dotenvx.com)

      at _log (node_modules/.pnpm/dotenv@17.2.0/node_modules/dotenv/lib/main.js:136:11)

PASS tests/unit/auth/auth.middleware.test.ts
  Auth Middleware
    authMiddleware
      ‚àö should authenticate user with valid token (15 ms)
      ‚àö should return 401 if no token provided (13 ms)
      ‚àö should return 401 if token is invalid (11 ms)
      ‚àö should return 401 if token is expired (11 ms)
      ‚àö should attach user with multiple roles to request (49 ms)
      ‚àö should handle malformed JWT token (13 ms)
      ‚àö should handle missing cookies object (11 ms)
    rolesMiddleware
      ‚àö should allow access if user has required role (22 ms)
      ‚àö should allow access if user has one of multiple required roles (14 ms)
      ‚àö should deny access if user does not have required role (15 ms)
      ‚àö should return 401 if user is not authenticated (12 ms)
      ‚àö should return 401 if user has no roles (23 ms)
      ‚àö should allow ADMIN role to access admin-only routes (16 ms)
      ‚àö should handle PARTNER role correctly (31 ms)
      ‚àö should handle AUTHORITY role correctly (20 ms)
      ‚àö should handle DISTRIBUTOR role correctly (39 ms)
      ‚àö should deny access when user has only unmatched roles (15 ms)
      ‚àö should allow access with user having multiple roles including required (11 ms)
      ‚àö should work with empty roles array for user (edge case) (11 ms)

  console.log
    [dotenv@17.2.0] injecting env (22) from .env.test (tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild)

      at _log (node_modules/.pnpm/dotenv@17.2.0/node_modules/dotenv/lib/main.js:136:11)

PASS tests/unit/utils/response.util.test.ts
  ResponseUtil
    success
      ‚àö should return success response with default status 200 (13 ms)
      ‚àö should return success response with custom status code (9 ms)
      ‚àö should include additional meta if provided (9 ms)
    successList
      ‚àö should return paginated list with correct metadata (9 ms)
      ‚àö should calculate hasNextPage correctly when on last page (8 ms)
      ‚àö should handle pagination with default values (22 ms)
    created
      ‚àö should return 201 status with created message (13 ms)
    error
      ‚àö should return error response with status code (18 ms)
      ‚àö should include validation errors if provided (15 ms)
    validationError
      ‚àö should return 400 validation error response (11 ms)
    unauthorized
      ‚àö should return 401 unauthorized response (9 ms)
    forbidden
      ‚àö should return 403 forbidden response (11 ms)
    notFound
      ‚àö should return 404 not found response (10 ms)
      ‚àö should accept resource name and identifier parameter (8 ms)
    conflict
      ‚àö should return 409 conflict response (11 ms)
      ‚àö should accept field parameter (8 ms)
    internalError
      ‚àö should return 500 internal server error (12 ms)
      ‚àö should use default error message if none provided (13 ms)
    timestamp format
      ‚àö should include ISO timestamp in all responses (11 ms)
    requestId tracking
      ‚àö should include requestId from request when available (13 ms)
      ‚àö should handle missing requestId gracefully (11 ms)

Test Suites: 1 failed, 8 passed, 9 total
Tests:       229 passed, 229 total
Snapshots:   0 total
Time:        85.86 s
Ran all test suites matching tests/unit|tests/unit/sale/sale.controller.test.ts.
‚ÄâELIFECYCLE‚Äâ Command failed with exit code 1.
